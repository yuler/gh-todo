#!/usr/bin/env bash
set -eo pipefail
IFS=$'\n\t'

help() {
    cat <<-EOF
Usage: gh todo

[GitHub CLI] extension for todo list manager via GitHub issues

Actions:
    init        Create \`todo\` repo
    home        Open \`issues\` web page
    add         Add todo item
    list        Show todo list

Examples:
    gh todo add abc
EOF
}

version="0.2.2"
today=$(date +"%Y-%m-%d")

repo="$(gh config get -h github.com user)/todo"

if [ -n "$GH_TODO_REPOSITORY" ]; then
      repo="$GH_TODO_REPOSITORY"	
fi

template_repo=https://github.com/yuler/template-todo

if [ -n "$GH_TODO_TEMPLATE_REPOSITORY" ]; then
      template_repo="$GH_TODO_TEMPLATE_REPOSITORY"	
fi

get_issue_id() {
    gh issue list --search "$today" --json "number" --jq ".[0].number" --repo $repo
}

init() {
    exec gh repo create --confirm --private --template="$template_repo" todo
}

home() {
    gh issue list --web --repo $repo
}

add() {
    input="$1"
    issue_id=$(get_issue_id)
    if [[ -z $issue_id ]]; then
        exec gh issue create --title $today --body "- [ ] $input" --repo $repo
    else
        body=$(gh issue list --search "$today" --json "body" --jq ".[0].body" --repo $repo)
        body=$(echo -e "$body\n- [ ] $input")
        exec gh issue edit $issue_id --body "$body" --repo $repo
    fi
}

list() {
    issue_id=$(get_issue_id)
    if [[ -z $issue_id ]]; then
        echo "No plans for today yet."
    else
        exec gh issue view $issue_id --repo $repo
    fi
}

# main
if [[ $# -eq 0 ]]; then
    list
    exit 0
fi

while [ $# -gt 0 ]; do
    case "$1" in
    -v | --version)
        echo $version
        exit 0
        ;;
    -h | --help)
        help
        exit 0
        ;;
    init)
        init
        shift
        ;;
    home)
        home
        shift
        ;;
    add)
        if [[ -z "$2" ]]; then
            echo -n "[Enter]: "
            read -e -r input
        else
            shift
            input=$*
        fi
        add "$input"
        ;;
    list)
        list
        ;;
    *)
        help >&2
        exit 1
        ;;
    esac
    shift
done
